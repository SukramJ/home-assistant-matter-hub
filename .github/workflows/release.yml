name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (CalVer: YYYY.M.patch, e.g., 2026.1.0)'
        required: true
        type: string
      channel:
        description: 'Release channel'
        required: true
        type: choice
        options:
          - latest
          - beta
        default: latest

permissions:
  contents: read

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - name: Validate CalVer format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]{4}\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$ ]]; then
            echo "Error: Version must be in CalVer format (YYYY.M.patch or YYYY.M.patch-beta.N)"
            echo "Examples: 2026.1.0, 2026.2.1, 2026.1.0-beta.1"
            exit 1
          fi

  release:
    needs: [validate]
    permissions:
      contents: write
      packages: write
      id-token: write
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.setup.outputs.node-version }}
      release-version: ${{ inputs.version }}
      release-channel: ${{ inputs.channel }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Environment
        id: setup
        uses: ./.github/actions/setup-node

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Test
        run: pnpm run test

      - name: Update Version
        run: |
          pnpm version --workspaces --no-workspaces-update --no-git-tag-version --allow-same-version ${{ inputs.version }}

      - name: Build
        run: pnpm run build

      - name: Package
        run: pnpm --filter home-assistant-matter-hub run bundle

      - name: Generate Changelog
        id: changelog
        run: |
          # Generate changelog from git commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"* %s (%h)" "$LAST_TAG"..HEAD)
          else
            COMMITS=$(git log --pretty=format:"* %s (%h)" -20)
          fi

          cat > CHANGELOG.md << EOF
          ## [${{ inputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}) ($(date +%Y-%m-%d))

          ### Changes

          $COMMITS
          EOF

          cat CHANGELOG.md

      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes-file CHANGELOG.md \
            ${{ inputs.channel == 'beta' && '--prerelease' || '' }} \
            apps/home-assistant-matter-hub/package.tgz \
            CHANGELOG.md

      - name: Upload Package Artifact
        uses: actions/upload-artifact@v5
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/package.tgz

      - name: Upload Documentation
        uses: actions/upload-pages-artifact@v4
        with:
          path: "./docs/_build/html"

  prepare-docker:
    name: "Prepare Docker"
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.dockerfiles.outputs.dockerfiles }}
    steps:
      - uses: actions/checkout@v6
      - name: Find Dockerfiles
        id: dockerfiles
        uses: ./.github/actions/find-dockerfiles

  docker:
    name: "Build Docker"
    runs-on: ubuntu-24.04-arm
    needs: [prepare-docker, release]
    permissions:
      packages: write
    strategy:
      matrix:
        dockerfile: ${{ fromJSON(needs.prepare-docker.outputs.dockerfiles) }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Docker
        uses: ./.github/actions/setup-docker

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Package Artifact
        uses: actions/download-artifact@v6
        with:
          name: package.tgz
          path: apps/home-assistant-matter-hub/
          merge-multiple: true

      - name: Build Docker
        uses: ./.github/actions/docker
        with:
          push: true
          channel: ${{ needs.release.outputs.release-channel }}
          dockerfile: ${{ matrix.dockerfile }}
          node-version: ${{ needs.release.outputs.node-version }}
          package-version: ${{ needs.release.outputs.release-version }}

  publish-pages:
    name: "Publish Documentation"
    runs-on: ubuntu-latest
    needs: [release]
    if: inputs.channel == 'latest'
    permissions:
      id-token: write
      pages: write
    steps:
      - name: Deploy documentation to GitHub Pages
        uses: actions/deploy-pages@v4

  update-addon:
    name: "Update Add-on Version"
    runs-on: ubuntu-latest
    needs: [release, docker]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Add-on Config
        run: |
          if [ "${{ inputs.channel }}" = "latest" ]; then
            ADDON_DIR="hamh"
          else
            ADDON_DIR="hamh-beta"
          fi

          # Update version in config.yaml
          sed -i "s/^version: .*/version: \"${{ inputs.version }}\"/" "$ADDON_DIR/config.yaml"

          # Update CHANGELOG
          cat > "$ADDON_DIR/CHANGELOG.md" << 'EOF'
          ## [${{ inputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}) ($(date +%Y-%m-%d))

          See [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}) for details.
          EOF

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "${{ inputs.channel }}" = "latest" ]; then
            ADDON_DIR="hamh"
          else
            ADDON_DIR="hamh-beta"
          fi

          git add "$ADDON_DIR/config.yaml" "$ADDON_DIR/CHANGELOG.md"
          git diff --cached --quiet || git commit -m "chore(addon): update $ADDON_DIR to v${{ inputs.version }}"
          git push
